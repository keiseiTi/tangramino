# 协同编辑示例

基于 CRDT（冲突自由复制数据类型）技术和 WebSocket 实现实时多人协同编辑，支持多用户同时编辑同一文档而无需中央服务器协调。

## 在线演示

[🔗 在新窗口打开协同编辑演练场](https://keiseiti.github.io/tangramino/playground/collab)

:::tip 多人协作测试
开启多个浏览器标签页访问上述链接，即可体验实时多人协同编辑效果。
:::

## 核心特性

- **实时同步**：基于 Loro CRDT 库实现的强一致性数据同步
- **离线支持**：用户离线时可继续编辑，重新连接后自动同步
- **冲突解决**：CRDT 算法自动解决并发编辑冲突
- **房间隔离**：支持多个独立的协同编辑会话
- **Peer 管理**：实时显示在线用户列表
- **自动重试**：连接失败时自动进行指数退避重试

## 快速开始

### 安装依赖

协同编辑插件已内置 Loro CRDT 库，只需安装 Socket.IO 客户端：

```bash
npm install socket.io-client
```

:::info Loro CRDT 内部集成
从 v0.1.0 开始，Loro CRDT 已集成到 `@tangramino/base-editor` 中，无需单独安装。
:::

### 启动协同编辑

```typescript
import { EditorProvider, collaborationPlugin } from '@tangramino/base-editor';
import { io } from 'socket.io-client';

const EditorPage = () => {
  const plugins = [
    collaborationPlugin({
      serverUrl: 'http://localhost:3001',
      roomId: 'my-document',
      peerId: 'user-123', // 可选
      autoConnect: true,  // 初始化时自动连接
      socketIO: io,       // Socket.IO 客户端
      maxRetries: 5,      // 最大重试次数（默认：5）
      retryDelay: 1000,   // 初始重试延迟（默认：1000ms）
    }),
  ];

  return (
    <EditorProvider
      materials={materials}
      schema={initialSchema}
      plugins={plugins}
    >
      <YourEditor />
    </EditorProvider>
  );
};
```

## 配置选项

### CollaborationOptions

| 选项          | 类型             | 必需 | 默认值   | 说明                       |
| ------------- | ---------------- | ---- | -------- | -------------------------- |
| `serverUrl`   | string           | ✅   | -        | WebSocket 协同服务器地址   |
| `roomId`      | string           | ✅   | -        | 协同编辑房间 ID            |
| `peerId`      | string \| bigint | ❌   | 随机生成 | 用户的唯一标识符           |
| `autoConnect` | boolean          | ❌   | true     | 初始化时是否自动连接服务器 |
| `loro`        | { LoroDoc }      | ✅   | -        | Loro CRDT 库实例           |
| `socketIO`    | SocketIOClient   | ✅   | -        | Socket.IO 客户端工厂函数   |
| `retryDelay`  | number           | ❌   | 1000     | 初始重试延迟（毫秒）       |

## 插件 API

协同编辑插件在 `EditorProvider` 的上下文中提供以下扩展方法：

### 连接管理

```typescript
const { connect, disconnect, isConnected } = useEditorCore();

// 手动连接
await connect();

// 手动断开连接
disconnect();

// 检查连接状态
if (isConnected()) {
  console.log('已连接到协同服务器');
}
```

### 信息查询

```typescript
const { getPeers, getRoomId } = useEditorCore();

// 获取在线用户列表
const peers = getPeers(); // ['user-123', 'user-456']

// 获取当前房间 ID
const roomId = getRoomId(); // 'my-document'
```

## 后端部署

协同编辑需要后端服务处理房间管理和更新广播。

### 启动服务器

```bash
cd playground/collab-server

# 开发环境
npm run dev

# 生产环境
npm run build
npm run start
```

### 环境配置

```bash
# .env
PORT=3001
CORS_ORIGIN=http://localhost:7901
```

### 服务器 API

后端服务提供以下 REST 端点：

- **GET /health** - 健康检查，返回在线房间数
- **GET /rooms** - 列出所有房间及其连接数

### Socket.IO 事件

#### 客户端发送

| 事件           | 数据                         | 说明                   |
| -------------- | ---------------------------- | ---------------------- |
| `join-room`    | `{ roomId, peerId }`         | 加入协同编辑房间       |
| `sync-request` | `{ roomId, version? }`       | 请求文档快照或增量     |
| `update`       | `{ roomId, update, peerId }` | 发送本地编辑更新       |
| `init-schema`  | `{ roomId, snapshot }`       | 初始化空房间的文档状态 |

#### 服务器广播

| 事件            | 数据                               | 说明                           |
| --------------- | ---------------------------------- | ------------------------------ |
| `room-joined`   | `{ roomId, peers }`                | 成功加入房间，返回现有用户列表 |
| `sync-response` | `{ roomId, snapshot, isSnapshot }` | 返回文档快照或增量更新         |
| `remote-update` | `{ roomId, update, peerId }`       | 其他用户的编辑更新             |
| `peer-joined`   | `{ peerId }`                       | 新用户加入房间                 |
| `peer-left`     | `{ peerId }`                       | 用户离开房间                   |
| `sync-error`    | `{ error }`                        | 同步错误                       |

## 工作流程

### 初始化连接

1. 用户加载编辑器时，插件初始化 Loro 文档
2. 如果启用自动连接，立即连接到协同服务器
3. 建立 Socket 连接并发送 `join-room` 事件
4. 服务器返回 `room-joined` 事件，包含在线用户列表
5. 客户端发送 `sync-request` 请求文档状态
6. 服务器返回 `sync-response`，包含文档快照或增量

### 本地编辑同步

1. 用户在编辑器中进行操作（插入、移动、删除、更新属性）
2. 插件检测到 schema 变化后自动调用 `syncToServer()`
3. Schema 序列化为 JSON 并写入 Loro 文档
4. Loro 文档导出为二进制 update 并通过 `update` 事件发送
5. 服务器接收 update，导入到房间的 Loro 文档
6. 服务器广播 `remote-update` 给其他在线客户端
7. 其他客户端导入 update 并更新本地编辑器 schema

### 远程更新接收

1. 客户端接收服务器的 `remote-update` 事件
2. **验证消息**：检查 peerId 格式、roomId 匹配、update 数据有效性
3. 提取更新数据并导入到本地 Loro 文档
4. Loro 订阅回调触发，调用 `ctx.setSchema()` 更新编辑器
5. 编辑器 UI 自动重新渲染，展示其他用户的编辑结果

### 错误恢复

1. **连接失败**：自动触发指数退避重试（1s → 2s → 4s → 8s → 16s）
2. **同步失败**：重新请求完整快照
3. **服务器断开**：自动重连并重新同步
4. **消息验证失败**：忽略无效消息并记录警告

## 高级用法

### 自定义 Peer ID

默认情况下，插件会随机生成 53 位整数作为 peerId。可以传入自定义值：

```typescript
collaborationPlugin({
  // ...
  peerId: 'user-' + currentUser.id, // 使用用户 ID
  // ...
});
```

### 延迟连接

如果需要稍后手动连接（例如等待用户授权）：

```typescript
const { connect } = useEditorCore();

// 初始化时不连接
const plugins = [
  collaborationPlugin({
    // ...
    autoConnect: false,
  }),
];

// 用户授权后手动连接
const handleConnect = async () => {
  try {
    await connect();
    console.log('已连接');
  } catch (error) {
    console.error('连接失败:', error);
  }
};
```

### 自定义重试策略

```typescript
collaborationPlugin({
  // ...
  maxRetries: 10, // 最多重试 10 次
  retryDelay: 2000, // 初始延迟 2 秒
  // 实际延迟：2s, 4s, 8s, 16s, 32s, 64s, ...
});
```

### 监听连接事件

在 `onInit` 或其他生命周期中监听连接状态变化：

```typescript
const { isConnected, getPeers } = useEditorCore();

useEffect(() => {
  const interval = setInterval(() => {
    if (isConnected()) {
      const peers = getPeers();
      console.log('在线用户:', peers);
    }
  }, 1000);

  return () => clearInterval(interval);
}, []);
```

## 技术栈

- **CRDT 库**：Loro（支持冲突自由复制，内部集成）
- **通信**：Socket.IO内部集成，自动管理）
- **通信**：Socket.IO WebSocket（外部传入，可替换）
- **后端框架**：Fastify + Node.js
- **编辑器**：Tangramino Base Editor

:::info 为什么 Loro 内部集成而 Socket.IO 外部传入？

- **Loro CRDT**：不同 CRDT 库的 API 差异巨大（Loro、Yjs、Automerge），应用层无法通过简单配置替换。因此直接内置 Loro，简化使用流程。
- **Socket.IO**：通信层接口相对标准，应用层可以用 WebSocket、WebRTC、HTTP 轮询等方案替换。保持外部传入提供最大灵活性。

## 使用场景

适用于需要多人实时协作的场景，如：

- 👥 团队协作编辑页面布局
- 📝 共享文档协编
- 🎨 设计稿协同修改
- ⚙️ 流程编排多人参与

## 最佳实践

### 推荐做法

- 使用 UUID 或业务用户 ID 作为 peerId，便于用户识别
- 在关键操作前检查 `isConnected()` 状态
- 配置合理的重试策略，避免无限重试消耗资源
- 在生产环境部署多个协同服务器实例，使用负载均衡
- 定期持久化文档状态，防止服务器重启数据丢失

### 注意事项

- **持久化**：当前服务器仅将文档存储在内存中，建议集成 Redis/数据库
- **认证**：生产环境需添加房间访问权限控制
- **扩展性**：在线人数过多时，考虑实现更新订阅过滤（而非广播所有更新）
- **离线同步**：用户长时间离线后重新连接，可能有大量待同步更新
- **消息验证**：插件已内置 peerId、roomId 和数据格式验证

## 故障排除

### 连接失败

**症状**：`isConnected()` 始终返回 false

**排查步骤**：

1. 确认服务器正在运行：`GET http://localhost:3001/health`
2. 检查 `serverUrl` 是否正确
3. 检查浏览器控制台是否有 CORS 错误
4. 验证防火墙是否阻止 WebSocket 连接
5. 查看是否超过最大重试次数（默认 5 次）

### 数据不同步

**症状**：其他用户的编辑在本地看不到

**排查步骤**：

1. 检查 `isConnected()` 是否为 true
2. 查看浏览器网络标签，确认 Socket.IO 消息是否正常发送/接收
3. 检查服务器日志中是否有 import 错误
4. 验证所有客户端连接的是同一个 `roomId`
5. 尝试手动调用 `disconnect()` 后重新 `connect()`

### 频繁重连

**症状**：连接不稳定，频繁断开重连

**排查步骤**：

1. 检查网络稳定性
2. 增加 `maxRetries` 和 `retryDelay` 配置
3. 检查服务器是否有资源限制（连接数、内存）
4. 查看服务器日志是否有异常断开记录

### 多个用户同时编辑时出现冲突

**说明**：这是正常行为，Loro CRDT 会自动解决冲突。每个用户都会看到一致的最终状态。

如果看到不同结果，检查：

1. Schema 序列化/反序列化逻辑是否正确
2. Loro 文档的导入/导出操作是否有异常
3. 服务器是否正确广播所有更新

## 示例项目

完整的协同编辑示例源码：

- **演练场地址**：[https://keiseiti.github.io/tangramino/playground/collab](https://keiseiti.github.io/tangramino/playground/collab)
- **前端源码**：[playground/antd-demo](https://github.com/keiseiti/tangramino/tree/main/playground/antd-demo/src/editor)
- **后端源码**：[playground/collab-server](https://github.com/keiseiti/tangramino/tree/main/playground/collab-server)

## 相关链接

- [Loro CRDT 官方文档](https://loro.dev/)
- [Socket.IO 文档](https://socket.io/docs/)
- [插件开发](../guide/plugin)
- [API 参考 - 协同编辑插件](../api/other/plugin#collaborationplugin)
